<h2>NL FRUTAS – PRIORIZAÇÃO</h2>

<input id="nome" placeholder="Seu nome">
<input id="codcli" placeholder="Código da Loja">

<button onclick="carregar()">Carregar Loja</button>
<button onclick="limpar()">Limpar Dia</button>

<input id="busca" placeholder="Buscar produto" onkeyup="listar()">
<label><input type="checkbox" id="pendente" onchange="listar()"> Só pendentes</label>

<h3>Total a pegar: <span id="total">0</span></h3>

<table id="tabela"></table>

<script>
function carregar() {
  const cod = document.getElementById("codcli").value;
  google.script.run.carregarPorCliente(cod);
  setTimeout(listar, 800);
}

function listar() {
  google.script.run.withSuccessHandler(dados => {
    let html = "";
    let total = 0;
    const busca = document.getElementById("busca").value.toLowerCase();
    const soPendente = document.getElementById("pendente").checked;

    for (let i = 1; i < dados.length; i++) {
      if (soPendente && dados[i][5] === "OK") continue;
      if (busca && !dados[i][3].toLowerCase().includes(busca)) continue;

      total += dados[i][5] !== "OK" ? Number(dados[i][4]) : 0;

      html += `
        <tr>
          <td>${dados[i][1]}</td>
          <td>${dados[i][3]}</td>
          <td>${dados[i][4]}</td>
          <td>${dados[i][5]}</td>
          <td>${dados[i][6] || ""}</td>
          <td>
            ${dados[i][5] !== "OK"
              ? `<button onclick="ok(${i+1})">OK</button>`
              : "✔"}
          </td>
        </tr>`;
    }

    document.getElementById("total").innerText = total;
    document.getElementById("tabela").innerHTML = html;
  }).listarControle();
}

function ok(linha) {
  const nome = document.getElementById("nome").value;
  if (!nome) return alert("Informe seu nome");
  google.script.run.marcarOK(linha, nome);
  setTimeout(listar, 500);
}

function limpar() {
  if (confirm("Limpar o dia inteiro?")) {
    google.script.run.limparDia();
    setTimeout(listar, 500);
  }
}

listar();
</script>

